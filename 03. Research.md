# Комплексный анализ PRD/BRD и ответы Researcher (без сокращений)

> На основе предоставленных **PRD** и **BRD** документов, а также внешних источников. Ключевые требования из PRD/BRD: интеграции с Google Lighthouse, Google Search Console, Яндекс.Вебмастер; доступность сервиса не ниже 99 процентов; время полного аудита не более 5 минут для сайтов до 100 страниц; локальное хранение доступов с шифрованием AES‑256; приоритизация по схеме MoSCoW; модель Freemium/Pro/Agency и целевые **KPI** по воронке (например, конверсия лид‑магнита в регистрацию не ниже 20 процентов).   &#x20;

---

## 1) Краткое резюме (4–5 ключевых выводов)

1. **Бэкенд**: для минимально жизнеспособного продукта подтверждаю выбор **NestJS (Node.js)** как основного бэкенда с готовыми экосистемными библиотеками под Lighthouse и генерацию PDF через браузерный движок; для перспективных функций на основе искусственного интеллекта предлагаю параллельно держать **микросервис на FastAPI (Python)**. Это снижает риски и ускоряет интеграции. (Обоснование и источники см. §4.1)
2. **Хранилище временных рядов**: стартуем с **PostgreSQL + расширение TimescaleDB** для метрик Web Vitals и историй аудитов; оно даёт уплотнение, интервальные индексы и агрегации без вынесения в отдельную систему. Альтернативные базы временных рядов (InfluxDB, QuestDB) оставить в резерве до подтверждения нагрузки. (см. §4.2)
3. **Интеграции для минимально жизнеспособного продукта**: в приоритете **Google PageSpeed Insights API** в пакетном режиме (быстрее запустить, без собственной инфраструктуры браузеров, содержит лабораторные и полевые данные), затем включать Google Lighthouse в пакетном режиме для локального анализа специфики сайтов на 1С‑Битрикс. (см. §3.1 и §5.1)
4. **Набор тестов минимально жизнеспособного продукта**: готов финализированный перечень тестов с кодами `testCode`, весами, формулами штрафов и категорией критичности; включены проверки доступности, индексации, карты сайта и файла robots, перенаправлений, каноникал, SSL/HTTP Strict Transport Security, SEO‑метаданных, Core Web Vitals, JavaScript‑ошибок и др. (см. §2)
5. **Рынок и тарифы**: прямых SaaS‑инструментов, которые делают аудит именно «под 1С‑Битрикс» с одновременной глубокой интеграцией Lighthouse, Google Search Console и Яндекс.Вебмастер, немного; чаще — универсальные SEO‑аудиторы. Цена и монетизация у ключевых игроков: подписка (SE Ranking, Serpstat), пооперационные лимиты (Topvisor, Rush Analytics), лицензия на рабочее место (Screaming Frog). (см. §6)

---

## 2) Финализация набора тестов минимально жизнеспособного продукта (коды, веса, критичность)

Скоринг в BRD: «Скоринг сайта (0–100) = 100 − сумма штрафов по тестам; каждый тест имеет вес от 0,5 до 10 баллов по критичности».&#x20;

### 2.1 Таблица тестов минимально жизнеспособного продукта

| Категория                                            | Код теста (`testCode`) | Описание проверки                                                      | Условие провала                                        | Критичность | Вес (штраф, баллы) |
| ---------------------------------------------------- | ---------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------ | ----------- | ------------------ |
| Доступность и безопасность                           | `AVAIL_HTTP_5XX`       | Серверные ошибки при загрузке главной и выборки до 100 страниц         | Доля 5xx > 0 процентов                                 | P0          | 10                 |
| Доступность и безопасность                           | `SEC_HTTPS_ENFORCE`    | Принудительный HTTPS и корректные сертификаты                          | Нет редиректа HTTP→HTTPS или cert invalid              | P0          | 9                  |
| Индексация (Яндекс.Вебмастер, Google Search Console) | `IDX_ROBOTS_BLOCKED`   | Блокировки в robots.txt на важных разделах                             | Запрет индексации разделов с трафиковым потенциалом    | P0          | 8                  |
| Индексация                                           | `SITEMAP_EXISTS_VALID` | Наличие и валидность sitemap.xml; регистрация карты в Яндекс.Вебмастер | Нет sitemap или ошибки схемы/статуса                   | P1          | 7                  |
| Индексация                                           | `CANONICAL_VALID`      | Корректный тег canonical                                               | Отсутствует или на внешние домены/дубликаты            | P1          | 6                  |
| SEO‑метаданные                                       | `SEO_TITLE_LENGTH`     | Длина и уникальность `<title>`                                         | Длина < 10 или > 65 символов; дубликаты > 10 процентов | P2          | 4                  |
| SEO‑метаданные                                       | `SEO_META_DESC`        | Наличие и релевантность `<meta name="description">`                    | Отсутствует на > 20 проц. страниц                      | P2          | 3                  |
| Технические дубликаты                                | `DUP_CONTENT_HASH`     | Дубликаты контента по хэшу                                             | Кластеров дублей > порога (например, 5 процентов)      | P1          | 6                  |
| Перенаправления                                      | `REDIRECT_CHAINS`      | Цепочки редиректов > 1                                                 | Доля цепочек > 10 процентов                            | P2          | 4                  |
| Производительность (PageSpeed Insights / Lighthouse) | `PERF_LCP_THRESHOLD`   | Largest Contentful Paint по десктопу/мобайлу                           | Медиана LCP > 2,5 секунды                              | P1          | 6                  |
| Производительность                                   | `PERF_CLS_THRESHOLD`   | Cumulative Layout Shift                                                | CLS > 0,1                                              | P1          | 6                  |
| Производительность                                   | `PERF_INP_THRESHOLD`   | Interaction to Next Paint                                              | INP > 200 миллисекунд                                  | P1          | 6                  |
| Производительность                                   | `PERF_RESOURCES_BLOAT` | «Тяжёлые» ресурсы (> 1 мегабайт, не‑WebP/AVIF)                         | Доля «тяжёлых» > 10 процентов                          | P2          | 3                  |
| JavaScript‑ошибки                                    | `JS_CONSOLE_ERRORS`    | Ошибки в консоли при загрузке                                          | Ошибки на > 5 проц. страниц                            | P1          | 5                  |
| Доступность контента                                 | `A11Y_ALT_TEXT`        | Альтернативные тексты у изображений                                    | Отсутствуют у > 20 проц. значимых изображений          | P2          | 3                  |
| Безопасность заголовков                              | `SEC_HEADERS`          | Наличие HSTS, X‑Content‑Type‑Options, CSP (базовый)                    | Отсутствуют ключевые заголовки                         | P1          | 5                  |
| Микроразметка                                        | `SEO_SCHEMA_ORG`       | Наличие базовой микроразметки breadcrumbs / organization               | Отсутствует на шаблонных страницах                     | P3          | 2                  |
| Карточка сайта 1С‑Битрикс                            | `BX_UPDATE_CORE`       | Актуальность версии ядра 1С‑Битрикс                                    | Версия ниже минимально поддерживаемой                  | P1          | 5                  |
| Интеграции                                           | `INT_GSC_YW_CONNECTED` | Связки с Google Search Console и Яндекс.Вебмастер                      | Отсутствуют подключённые ресурсы                       | P2          | 3                  |

> Примечания:
> — Пороговые значения Core Web Vitals соответствуют рекомендациям Google; сами показатели доступны в PageSpeed Insights (лабораторные и полевые по данным Chrome User Experience).
> — Проверки карты сайта и диагностики ошибок для Яндекс.Вебмастер доступны через методы `user-added-sitemaps`, `diagnostics`, «история индексации».

### 2.2 Машиночитаемая спецификация тестов (для трекера и отчётов)

```json
{
  "version": "mvp-1.0",
  "scoring": "100 - sum(penalties)",
  "tests": [
    {"code":"AVAIL_HTTP_5XX","category":"availability","severity":"P0","weight":10,"failIf":"5xx_rate>0"},
    {"code":"SEC_HTTPS_ENFORCE","category":"security","severity":"P0","weight":9,"failIf":"http_to_https_redirect=false || cert_valid=false"},
    {"code":"IDX_ROBOTS_BLOCKED","category":"indexing","severity":"P0","weight":8,"failIf":"robots_blocks_important=true"},
    {"code":"SITEMAP_EXISTS_VALID","category":"indexing","severity":"P1","weight":7,"failIf":"sitemap_missing=true || sitemap_invalid=true"},
    {"code":"CANONICAL_VALID","category":"indexing","severity":"P1","weight":6,"failIf":"canonical_missing=true || canonical_crossdomain=true"},
    {"code":"SEO_TITLE_LENGTH","category":"seo","severity":"P2","weight":4,"failIf":"title_len<10 || title_len>65 || duplicate_titles_rate>0.1"},
    {"code":"SEO_META_DESC","category":"seo","severity":"P2","weight":3,"failIf":"missing_meta_desc_rate>0.2"},
    {"code":"DUP_CONTENT_HASH","category":"tech","severity":"P1","weight":6,"failIf":"duplicate_clusters_rate>0.05"},
    {"code":"REDIRECT_CHAINS","category":"tech","severity":"P2","weight":4,"failIf":"redirect_chain_rate>0.1"},
    {"code":"PERF_LCP_THRESHOLD","category":"performance","severity":"P1","weight":6,"failIf":"median_LCP>2500"},
    {"code":"PERF_CLS_THRESHOLD","category":"performance","severity":"P1","weight":6,"failIf":"CLS>0.1"},
    {"code":"PERF_INP_THRESHOLD","category":"performance","severity":"P1","weight":6,"failIf":"INP>200"},
    {"code":"PERF_RESOURCES_BLOAT","category":"performance","severity":"P2","weight":3,"failIf":"heavy_resources_rate>0.1"},
    {"code":"JS_CONSOLE_ERRORS","category":"tech","severity":"P1","weight":5,"failIf":"console_errors_rate>0.05"},
    {"code":"A11Y_ALT_TEXT","category":"accessibility","severity":"P2","weight":3,"failIf":"missing_alt_rate>0.2"},
    {"code":"SEC_HEADERS","category":"security","severity":"P1","weight":5,"failIf":"hsts=false || x_content_type_options=false"},
    {"code":"SEO_SCHEMA_ORG","category":"seo","severity":"P3","weight":2,"failIf":"schema_required_missing=true"},
    {"code":"BX_UPDATE_CORE","category":"bitrix","severity":"P1","weight":5,"failIf":"bitrix_core_version<min_supported"},
    {"code":"INT_GSC_YW_CONNECTED","category":"integrations","severity":"P2","weight":3,"failIf":"gsc_connected=false || ywebmaster_connected=false"}
  ]
}
```

> Веса согласованы с моделью из BRD (критические тесты получают 8–10 баллов).&#x20;

---

## 3) Приоритет интеграций: Google PageSpeed Insights в пакетном режиме против локального Google Lighthouse в пакетном режиме

**Рекомендация для минимально жизнеспособного продукта**: сначала подключаем **Google PageSpeed Insights API** в пакетном режиме, затем добавляем **Google Lighthouse** в пакетном режиме как «расширенный» анализ.

**Обоснование:**

* **Время запуска и ресурсы**: PageSpeed Insights API не требует собственной фермы браузеров, даёт лабораторные оценки Lighthouse и, при наличии данных, «полевые» метрики по Chrome User Experience. Это сокращает эксплуатационные расходы и снижает риск деградации соглашения об уровне сервиса на старте.
* **Квоты и масштабируемость**: публично задекларированные и подтверждённые многими источниками лимиты PageSpeed Insights при использовании ключа Google Cloud — **до 25 000 запросов в сутки** и **до \~240 запросов в минуту** (также встречается формулировка «400 запросов на 100 секунд»), с возможностью запроса увеличения квоты через консоль Google Cloud.
* **Локальный Lighthouse** даёт полноценный контроль (окружение, эмуляция, сценарии), но требует оркестрации безголовых браузеров и очередей заданий. Подготовка контейнеров и масштабирование в Kubernetes добавляют сложность (но это выполнимо и хорошо документировано; см. §4.3).

**Практический план:**

1. R1: PageSpeed Insights API (десктоп и мобильный режим) + кэширование ответов по URL. (см. §5.1 про размер ответа и бюджет времени)
2. R2: пакетный Google Lighthouse (по очередям) для прицельных страниц и углублённых сценариев.
3. R3: гибрид: PageSpeed для массового мониторинга; Lighthouse для детальных обследований, триаж по «красным» страницам.

---

## 4) Выбор стека и технологий

### 4.1 Бэкенд: подтверждение NestJS против FastAPI (и как совместить)

**Вывод**: для минимально жизнеспособного продукта подтверждаю **NestJS** как основной бэкенд (модульность, DI, фильтры, пайплайны, Guards), развёртываем отдельный сервис на **FastAPI** для будущей логики искусственного интеллекта и парсинга по Python‑экосистеме (при необходимости). NestJS и FastAPI общаются синхронно через HTTP/JSON или асинхронно через очередь сообщений (например, Redis Streams или RabbitMQ).

* NestJS = каркас поверх Node.js/Express с модульной архитектурой, фильтрами исключений, интерцепторами, валидацией и удобной структурой проекта.
* FastAPI = быстрая асинхронная разработка API, поддержка OpenAPI, pydantic‑валидация, высокая производительность Uvicorn/Starlette по тестам сообщества.
* Для интеграций с Lighthouse и генерации PDF под Node.js есть зрелые пакеты (`lighthouse`, `puppeteer`), а под Python — Playwright и `google-api-python-client` (см. §5.2 и §4.3).

### 4.2 Временные ряды метрик: PostgreSQL с расширением TimescaleDB против «чистого» PostgreSQL и отдельных СУБД временных рядов

**Вывод**: стартуем с **PostgreSQL + TimescaleDB** (расширение), так как это единый стек, SQL‑совместимость и готовые примитивы для временных рядов: **hypertables**, агрегаты по окнам, политики ретенции и **компрессия** (вплоть до кратного уменьшения объёма). Это простой способ хранить историю Core Web Vitals, историю аудитов и их сводки.

* Когда уйдём на десятки миллионов записей и возникнут специфические требования к ретенциям/скорости ingest — тогда вернёмся к оценке **InfluxDB** или **QuestDB**.
* До тех пор **PostgreSQL + TimescaleDB** покрывает аналитические запросы (агрегации по дням/неделям, перцентили, «срезы» по сегментам страниц) без смены стека.

### 4.3 Безголовые браузеры и масштабирование (Docker/Kubernetes)

* Официальные контейнеры **Playwright** с предустановленными браузерами, тестовыми утилитами и шрифтами; есть инструкции по Docker и CI. Рекомендации по параллелизму, шардингу и ограничению ресурсов (CPU/память) позволяют стабильно масштабировать.
* **Google Lighthouse** поставляется как Node‑модуль; для пакетного режима используем готовые Docker‑образы или собираем свой (Chrome/Chromium с нужными флагами).
* Типовая архитектура: «очередь заданий» + **воркеры** (BullMQ для Node.js или Celery для Python) с жёсткими лимитами параллелизма браузеров на под и **PodDisruptionBudget**. (См. §5.4 по тестам нагрузки.)

---

## 5) Интеграции и детали API

### 5.1 Google PageSpeed Insights API — актуальные эндпоинты, квоты, размер ответов, что брать в минимально жизнеспособный продукт

* **Базовый эндпоинт**: `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=...` (поддерживает стратегии «desktop» и «mobile»; возвращает данные Lighthouse и, если доступны, полевые показатели Chrome User Experience).
* **Квоты**: при использовании ключа Google Cloud распространённый предел — **до 25 000 запросов в сутки** и **до \~240 запросов в минуту** (иногда формулируется «400 на 100 секунд»); квоты управляются в консоли Google Cloud и могут быть увеличены по заявке.
* **Размер ответа**: полный JSON отчёта Lighthouse «тяжёлый» (содержит детальные артефакты и списки сетевых запросов); на практике это **сотни килобайт и до нескольких мегабайт** в зависимости от числа артефактов и включённых категорий. (Обсуждения по объёму и «тяжёлым» аудитам в Lighthouse указывают на существенные размеры отчётов.)

**Что оптимально для минимально жизнеспособного продукта:** вызывать PageSpeed Insights API в пакетном режиме только по «точкам интереса» (главная страница, листинг, карточка товара/услуги, контакты), запрашивая **минимально нужные поля** и кэшируя результат. Это обеспечивает укладывание в требование «аудит не более 5 минут» даже при десятках URL.

### 5.2 SDK и библиотеки

* **Node.js / NestJS**:
  — Пакет `lighthouse` (официальный Node‑модуль Lighthouse) для программных прогонов.
  — Пакет `googleapis` (Node‑клиент к Google API), включает «pagespeedonline» через Discovery.
  — Пакет `puppeteer` для PDF и браузерной автоматизации.
* **Python / FastAPI**:
  — `google-api-python-client` (вызовы PageSpeed Insights через Discovery).
  — **Yandex.Webmaster**: есть сторонний пакет `yandex-webmaster-api` (неофициальный), оборачивающий методы v4. Для продакшена предпочтительна тонкая обёртка поверх официальных HTTP‑эндпоинтов.

### 5.3 Яндекс.Вебмастер API — доступные методы и ограничения

* **Ключевые методы (v4)**:
  — Список и сведения о сайтах (hosts), статус подтверждения.
  — Диагностика ошибок сайта: доступность, безопасность, соответствие рекомендациям.
  — История индексации с разбивкой по статусам ответов.
  — Управление картами сайта: добавление и удаление Sitemap.
* **Лимиты по частоте запросов**: явных «чётких цифр» в документации нет; сервис использует стандартные коды ошибок и рекомендуемые подходы к экпоненциальным паузам при перегрузке. Практически — придерживаться скользящих окон и backoff при ответах 429, а также кешировать результаты, неизменные в течение суток.

### 5.4 Нагрузка: 50–100 одновременных аудитов и очереди

* Для **BullMQ (Node.js, Redis)** и **Celery (Python)** нет единых «официальных» бенчмарков именно под наш профиль, поскольку итоговая пропускная способность зависит от длительности работы браузера/сетевых вызовов и размеров отчётов. Рекомендую «тест производительности как код»: запускать набор из 50/100/200 заданий с ограничением параллелизма воркеров (например, 3–4 процесса браузера на под, 1–2 вкладки на процесс) и измерять «время завершения всех».
* **Окружение без деградации**: использовать официальные базовые образы Playwright, задавать `--disable-dev-shm-usage` и выделять отдельный том под `/tmp` при интенсивной генерации PDF (см. ниже).

### 5.5 Генерация отчётов PDF: локально или внешним сервисом

* **Локально**: `puppeteer` умеет генерировать PDF из HTML. Это гибко, но требует контейнеров с Chromium и внимательной настройки (шрифты, размер `--no-sandbox` в Kubernetes по политике безопасности).
* **wkhtmltopdf** официально не поддерживается в текущем виде (проект признан устаревшим), поэтому не рекомендую для новой разработки.
* **Выделенный сервис**: **Gotenberg** — микросервис для конвертации HTML → PDF на базе Chromium, удобен в Kubernetes (горизонтальное масштабирование, лимиты). Хороший вариант вынесения «тяжёлой» операции.

---

## 6) Конкуренты и рынок (функционал, интеграции, тарифы, отличия)

> Прямых SaaS с «заточкой» именно под 1С‑Битрикс и одновременной глубокой интеграцией Google Lighthouse, Google Search Console и Яндекс.Вебмастер немного. Чаще встречаются универсальные SEO‑аудиторы; некоторые из них позволяют подключать Google Search Console, а работа с Яндекс.Вебмастер — точечно через выгрузки и ручные отчёты.

| Продукт                                 | Позиционирование и функции                                               | Интеграции (Google Search Console / Яндекс.Вебмастер / Lighthouse)                                                             | Модель монетизации                                        | Индикативные цены                                                                                     |
| --------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **SE Ranking**                          | Полный набор: аудит сайта, трекинг позиций, обратные ссылки, отчёты      | Официальная интеграция с Google Search Console и Google Analytics (подтверждено в базе знаний)                                 | Подписка (помесячно/год)                                  | «Essential» от \~52–65 долларов в месяц; «Pro» выше (страница тарифов)                                |
| **Serpstat**                            | Технический аудит, исследование ключевых слов, анализ ссылок             | Функции Core Web Vitals/страничной скорости освещаются в контенте; интеграции Google Search Console/Analytics зависят от плана | Подписка                                                  | «Individual» от \~50 долларов в месяц; «Team» \~100 долларов в месяц (страница тарифов)               |
| **Topvisor**                            | Российский онлайн‑сервис: проверка позиций, аудит сайта («80+ сигналов») | Руководства описывают совместное использование с Яндекс.Вебмастер и Google Search Console (практика)                           | Пооперационная тарификация (стоимость за проверку/модуль) | Пример: цена за проверку позиций от 0,09 рубля; аудит — по лимитам тарифа (страницы продукта и блога) |
| **Rush Analytics**                      | Инструменты по кластеризации, аудит сайта, контент                       | Модель лимитов по инструментам                                                                                                 | Подписка + лимиты                                         | Лимиты на аудит сайта зависят от плана; прайс в справке и тарифах                                     |
| **Screaming Frog SEO Spider** (десктоп) | Мощный краулер и технический аудит, API‑интеграции                       | Локальный инструмент; интеграции с поисковыми API через подключение                                                            | Лицензия «per user»                                       | Бесплатно до 500 URL; платная лицензия **£199 в год** на пользователя (официальная страница)          |

> **Замечание**: Обзоры и агрегаторы (TechRadar и др.) подтверждают доминирование универсальных инструментов и присутствие Screaming Frog среди «стандартов» технического аудита.

**Функции искусственного интеллекта у конкурентов**: чаще встречаются как «ассистенты» для формулировки рекомендаций и резюме аудита. Практическая ценность выше там, где ИИ подхватывает **приоритизацию задач** (связка «влияние на трафик × сложность исправления») и **генерацию технических заданий**. «Маркетинговые» фичи — свободные «перефразы» отчёта без опоры на данные.

---

## 7) Нагрузочные оценки (50 / 500 / 5000 страниц) и риски блокировок

### 7.1 Оценка времени

* **50 страниц**: при стратегии «точек интереса» (5–10 страниц на PageSpeed Insights + краул в один поток по «внутренним» проверкам) и кэшировании — обычно **1–2 минуты**. Узким местом является очередь вызовов PageSpeed Insights (см. квоты).
* **500 страниц**: без полного Lighthouse по каждой странице; выполняем: краул (сетка запросов, заголовки, каноникал, редиректы), выборочные PageSpeed Insights для 20–30 страниц. Реалистично уложиться **в 5 минут** при параллелизме краулера и ограничении на «тяжёлые» шаги.
* **5000 страниц**: для минимально жизнеспособного продукта предлагаем «sampling» (например, 100–150 страниц по шаблонам) + глубокий аудит по ключевым шаблонам; полный обход — асинхронно, с уведомлением по готовности.

> Расчёт основан на архитектурной стратегии из PRD/BRD: требование «не более 5 минут» относится к «типичному сайту до 100 страниц»; для крупных сайтов используем сэмплирование.&#x20;

### 7.2 Потенциальные блокировки (Cloudflare, авторизация)

* **Cloudflare Bot Management / Super Bot Fight Mode** может предъявлять челленджи (hCaptcha, JavaScript‑проверки) и блокировать безголовые браузеры; при массовом сканировании важно уважать правила, задавать разумный `User-Agent`, скорость, и **поддерживать «ручной режим» сканирования** через установленный модуль в 1С‑Битрикс (авторизованный доступ). (Документация Cloudflare описывает типы челленджей и принципы отбора трафика.)
* **Авторизация**: для закрытых разделов — запуск аудита из установленного модуля (локальное выполнение части тестов) согласно гибридной архитектуре в PRD.&#x20;

---

## 8) Юридические требования и публикация в маркетплейсе 1С‑Битрикс

### 8.1 Обработка персональных данных (Федеральный закон № 152‑ФЗ) и Общий регламент по защите данных Европейского союза (GDPR)

* В 2025 году обсуждаются и принимаются изменения, усиливающие **минимизацию данных** и **отдельность согласия** на обработку персональных данных; фокус на запрете «спрятанных» согласий и ограничениях доступа к содержимому при отказе от предоставления персональных данных. (Следим за обновлениями Роскомнадзора.)
* По **GDPR**: Европейский совет по защите данных (EDPB) в июне 2025 года утвердил окончательные **Руководства по статье 48** — о запросах персональных данных от властей третьих стран. Это особенно важно при трансграничной передаче данных и использовании зарубежных API/облаков.
* **Акт об искусственном интеллекте Европейского союза**: вступил в силу 1 августа 2024 года; часть обязанностей для поставщиков систем общего назначения вступает в силу 2 августа 2025 года. Для нашего продукта (аналитика сайтов) прямые обязанности высокой категории риска не просматриваются, но нужно отслеживать маркетинговые «ИИ‑модули» (генерация рекомендаций), если они будут продаваться на рынок Европейского союза.

**Практические меры для минимально жизнеспособного продукта** (уже отражены в PRD/BRD): локальное хранение доступов к аккаунтам клиентов (в модуле 1С‑Битрикс) с шифрованием AES‑256; минимизация собираемых данных, логирование вызовов внешних API, политика удаления данных.&#x20;

### 8.2 Публикация в «1С‑Битрикс: Маркетплейс» / «Bitrix24 Market»

* Требуются соблюдение **технических требований к оформлению решения** (структура, скриншоты, описания, языковые требования), **ведение логов запросов к REST** (для облачных приложений Bitrix24) и **партнёрский статус** (минимум «Технологический партнёр») для публикации.
* Документация по **процедуре публикации** и требованиям доступна на сайте Bitrix24 (подготовка к публикации, формы решения/версии).
* **Автоматизация обновлений модуля**: публичного API для «заливки» новой версии модуля в «1С‑Битрикс: Маркетплейс» не задокументировано; стандартная процедура — через кабинет партнёра (загрузка дистрибутива/версия). Для **облачных приложений Bitrix24** — своя процедура версионирования и проверки.

---

## 9) Интеграции с системами управления задачами (что проще через веб‑хуки, а что — по API)

| Система      | Веб‑хуки                                             | REST API        | Рекомендация для минимально жизнеспособного продукта                                                                                            |
| ------------ | ---------------------------------------------------- | --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **Jira**     | Поддерживаются (веб‑хуки по событиям проектов/задач) | Полный REST API | Старт через **веб‑хук приемник** для авто‑создания задач по критическим находкам; для би‑направленной синхронизации использовать REST после R1. |
| **YouTrack** | Поддерживаются                                       | Полный REST API | Аналогично: веб‑хуки для событий или входящий веб‑хук в нашем сервисе; при необходимости — REST для полей и связей.                             |
| **ClickUp**  | Поддерживаются                                       | Полный REST API | Начать с веб‑хуков (создание задач по событию «аудит завершён» и «обнаружен P0/P1»), затем расширить REST интеграции.                           |

---

## 10) Данные по конверсии лид‑магнитов (референсы для KPI в 20 процентов)

* По данным исследования Sumo (модальные окна/поп‑апы) **средняя конверсия \~3,1 процента**, у верхнего дециля — \~9,3 процента; это вспомогательная метрика для поп‑апов, но даёт ориентир по «первому касанию».
* Отчёты Unbounce и иные бенчмарки по посадочным страницам показывают медианные конверсии **в диапазоне 3–10 процентов** в зависимости от ниши; для IТ‑сервисов чаще ближе к 3–5 процентам. (Используем как нижний ориентир.)

> Вывод: **20 процентов** для лид‑магнита достижимы при высокой релевантности аудитории (например, аудит «под 1С‑Битрикс»), коротком пути до результата и сильном «value proposition». Зафиксировать в KPI‑дереве как целевую метрику — уже отражено в BRD.&#x20;

---

## 11) Ответы на вопросы (объединённо по двум спискам, без сокращений)

### 11.1 API и внешние интеграции

**1. Google PageSpeed Insights API — актуальные лимиты; какие методы оптимальны для минимально жизнеспособного продукта?**
— Эндпоинт `runPagespeed` (v5), стратегиия «desktop»/«mobile». Лимиты по умолчанию широко цитируются как **до 25 000 запросов в сутки** и **до \~240 запросов в минуту** при использовании ключа; квоты можно повышать через консоль Google Cloud. Для минимально жизнеспособного продукта берём **лабораторные оценки Lighthouse** и **полевые метрики** (если доступны), ограничивая список страниц.

**2. Яндекс.Вебмастер API — набор методов и ограничения по частоте**
— Доступны методы по **сайтам (hosts)**, **верификации**, **диагностике ошибок**, **истории индексации**, **управлению картами сайта**. Жёсткие «цифровые» лимиты в документации не публикуются; следует проектировать с экспоненциальными паузами и кэшированием.

**3. Готовые библиотеки под NestJS/FastAPI**
— Node.js: `lighthouse`, `googleapis` для PageSpeed Insights; Python: `google-api-python-client` для PageSpeed Insights; для Яндекс.Вебмастер есть сторонние обёртки (`yandex-webmaster-api`), в продакшене надёжнее тонкая обёртка поверх HTTP.

**4. Средний размер ответа API и влияние на пяти‑минутный бюджет**
— Полные отчёты Lighthouse объёмны (сотни килобайт и более), что влияет на транспорт и сериализацию. Для минимально жизнеспособного продукта используем **выборочную выборку страниц** и **кэш**; это помогает укладываться в 5 минут на типичные сайты до 100 страниц. &#x20;

### 11.2 Стек и производительность

**5. Нагрузочные бенчмарки для 50–100 одновременных аудитов (BullMQ/Celery)**
— Универсального эталона нет; итог зависит от длительности одного аудита (браузер/сеть/внешние API). Рекомендую «перформанс как код»: фиксированные профили (например, 3 процесса браузера × 2 вкладки, лимит памяти на под, 1 Redis на 2–3 воркера), тесты «нарастанием» 50→100→200 заданий. Документируем целевую метрику «время завершения всех» и предельный 95‑й перцентиль. (См. §4.3 о контейнерах и браузерах.)

**6. TimescaleDB против «чистого» PostgreSQL на кейсах Web Vitals**
— TimescaleDB даёт **hypertables**, политики ретенции и **компрессию**; для историй метрик это реальный выигрыш и упрощение запросов; остаёмся в SQL и в едином кластере БД.

**7. Опыт интеграции безголовых браузеров в контейнерах без деградации соглашения об уровне сервиса**
— Используем официальные образы Playwright, лимиты ресурсов, шардирование, изоляцию временных директорий, очередь заданий. Это стандартные практики; в случае пиков применять горизонтальное масштабирование и «ограничение параллелизма» для стабильности.

### 11.3 Конкуренты и best practices

**8. Кто уже делает аудит для 1С‑Битрикс с интеграциями Lighthouse/Google Search Console/Яндекс**
— Преимущественно универсальные системы: SE Ranking (поддерживает интеграцию Google Search Console), Serpstat (аудит и контент‑инструменты), Topvisor (российский сервис с «Анализом сайта», есть практики совместного использования с Яндекс.Вебмастер), Rush Analytics, а также настольный Screaming Frog. Прямой «комбо‑вариант» (именно «1С‑Битрикс» + «Lighthouse/Google Search Console/Яндекс» внутри одного SaaS) встречается редко.

**9. Конверсия лид‑магнита**
— Практические референсы: поп‑апы \~3 процента в среднем (лучшие — \~9 процентов), посадочные страницы — медианы 3–10 процентов по индустриям. Цель 20 процентов в BRD амбициозна, но достижима при хорошей «ценности за 1 клик». &#x20;

**10. Цены и модели тарифов на российском рынке для Pro и Agency**
— Подписка: SE Ranking (от \~\$52–65 за «Essential», далее выше), Serpstat (от \$50 за «Individual» и \~\$100 за «Team»). Лимит‑модели: Topvisor (пооперационная тарификация, пример — 0,09 рубля за проверку позиции; аудит по лимитам), Rush Analytics (лимиты на инструменты). Настольный Screaming Frog — £199 в год за лицензию на пользователя.

### 11.4 Риски и нормативные вопросы

**11. Изменения в законе Российской Федерации № 152‑ФЗ и Общем регламенте по защите данных**
— См. §8.1. Итог: дизайн минимально жизнеспособного продукта уже учитывает меры минимизации данных и локального хранения; трансграничные передачи (внешние API) — с оценкой правовых рисков и публичных политик. &#x20;

**12. Сертификация или согласование при публикации в Bitrix Marketplace**
— Требуются партнёрский статус и соблюдение технических/контентных требований и регламентов; **отдельной сертификации сверх технической проверки** документация не требует, но предусмотрены логи и требования к качеству, а также модерация.

**13. Наличие API у Bitrix Marketplace для автоматизации обновлений модуля**
— Для «1С‑Битрикс: Маркетплейс» (модули под CMS) публичного API «заливки» новой версии не задокументировано; публикация и обновления — через кабинет партнёра. Для Bitrix24‑приложений — свой регламент публикации/версий.

**14. Какие интеграции с задачниками проще через веб‑хуки/какие требуют API**
— См. §9 (таблица): начинать с веб‑хуков (создание задач на P0/P1), затем, при необходимости синхронизации статусов/пользовательских полей — REST API Jira/YouTrack/ClickUp.

---

## 12) Best practices по реализации

* **Оркестрация аудитов**: очередь задач, идемпотентность, кэш PageSpeed Insights по URL и стратегии (desktop/mobile) на 12–24 часа; «замок» на URL, чтобы не дублировать вызовы.
* **Профили нагрузок**: «малый» (до 100 страниц) — полный; «средний» (до 1000 страниц) — сэмплирование и/или только PageSpeed Insights на шаблонных страницах; «крупный» — пакетные задачи с уведомлением по готовности.
* **Отчёты**: HTML‑отчёт + PDF (через Puppeteer или Gotenberg), «чёрный ящик» с вложениями для задачников.
* **Данные и безопасность**: шифрование доступов к аккаунтам клиентов локально в модуле 1С‑Битрикс, ограничение ролей (владелец/SEO/разработчик), логирование вызовов REST (Bitrix24).&#x20;

---

## 13) Допущения BRD/PRD, гипотезы и их проверка

* **«Комплексный аудит повышает конверсию в доработки не менее чем на 10 процентов»** — проверка на 10 пилотных сайтах (зафиксировано в BRD). Статистически — A/B или до/после с контролем сезонности.&#x20;
* **«White‑label повышает удержание партнёрских агентств на 20 процентов»** — кастдев и когортный анализ удержания (зафиксировано в BRD).&#x20;
* **«Интеграции с Lighthouse и Google Search Console повышают полноту отчёта на 30 процентов»** — A/B‑тест по полноте закрытия чек‑листов.&#x20;

Если внешний валидирующий источник недоступен (например, разночтения по квотам), используем метод проверки: **контрольный прогон** с логированием кодов ответа/заголовков, усреднение по 3–5 сериям.

---

## 14) Риски и возможности

**Рынок**: зависимость от квот и политик Google и Яндекс (смягчение: кэш, очереди, fallback к локальному Lighthouse); изменения в правилах обработки персональных данных; изменения в лицензиях 1С‑Битрикс. &#x20;
**Технологии**: прекращение поддержки устаревших инструментов (wkhtmltopdf), «тяжёлые» отчёты Lighthouse (компрессия, архивирование); ограниченность опыта эксплуатации больших кластеров браузеров (смягчение: начать с PageSpeed Insights).
**Возможности**: ниша «под 1С‑Битрикс», white‑label для агентств, машинные подсказки с приоритизацией задач по эффекту, партнёрские каналы (Bitrix Marketplace, экосистема интеграторов).&#x20;

---

## 15) Handoff

### 15.1 Для System Architect

* **Рекомендуемые технологии**: NestJS (ядро API), Playwright/Lighthouse в контейнерах, очередь BullMQ, PostgreSQL + TimescaleDB, генерация PDF через Puppeteer либо внешний Gotenberg.
* **Лучшие практики**: кэширование PageSpeed Insights; «уровни строгости» тестов (P0–P3); конфигурируемые веса (из JSON); планировщик/воркер через Kubernetes Jobs; лимиты на параллельные браузеры; трассировка (OpenTelemetry).
* **Архитектурные решения**: микросервис FastAPI под искусственный интеллект и парсинг — изолированный воркер; агрегации метрик во «времянке» (TimescaleDB), материализованные представления для дашбордов.

### 15.2 Для Product Owner

* **Обновлённый перечень функций с конкурентной ценностью**:
  — Быстрый аудит «в 1 клик» с виджетом Core Web Vitals;
  — Подключения Google Search Console и Яндекс.Вебмастер (помощник по верификации, статус индексации, карта сайта);
  — White‑label PDF и HTML‑отчёт с приоритизацией задач;
  — Экспорт задач в Jira/YouTrack/ClickUp через веб‑хуки;
  — История аудитов и динамика метрик.

### 15.3 Для Business Analyst

* **KPI и экономика**: подтвердить воронку (лид‑магнит → регистрация ≥ 20 процентов; отчёт → обращение ≥ 10 процентов; оплата ≥ 30 процентов), удержание агентств по white‑label (+20 процентов), экономика (CAC, LTV, ROI, срок окупаемости). &#x20;
* **Методика скоринга**: закрепить JSON‑спецификацию тестов и веса (см. §2.2); целевая метрика — «средний скоринг ≥ 80/100» и «снижение критических ошибок ≥ 50 процентов» после исправлений.&#x20;

---

## 16) Приложение: ссылки на документацию и источники

* **PageSpeed Insights**: обзор и использование (Chrome for Developers); квоты и практика повышения квот через Google Cloud Console; материалы по ограничениям.
* **Lighthouse**: документация и Node‑пакет.
* **Яндекс.Вебмастер API (v4)**: hosts, верификация, диагностика, история индексации, карты сайта.
* **Playwright и Docker/Kubernetes**: официальные образы и рекомендации.
* **TimescaleDB**: руководство и справочник.
* **PDF‑генерация**: Puppeteer; статус wkhtmltopdf; Gotenberg.
* **Jira/YouTrack/ClickUp**: веб‑хуки и REST.
* **Рынок и цены**: SE Ranking, Serpstat, Topvisor, Rush Analytics, Screaming Frog.
* **Регуляторика**: 152‑ФЗ (обновления/толкования), EDPB по статье 48 GDPR, временная шкала Акта об искусственном интеллекте Европейского союза.

---

### Заключение по выбору «PageSpeed Insights против Lighthouse» для минимально жизнеспособного продукта

1. **Запускаемся** с Google PageSpeed Insights в пакетном режиме (минимум страниц + кэш);
2. **Добавляем** Google Lighthouse в пакетном режиме для таргетированных, расширенных обследований;
3. **Стандартизируем** выдачу (JSON по `testCode` + HTML + PDF) и экспорт в задачники через веб‑хуки.

Это обеспечивает выполнение требований PRD/BRD по времени аудита, доступности сервиса и дорожной карте релизов. &#x20;

---

**Дополнение к PRD — новая фича в MVP**

### **Функция: Конверсионная аналитика для 1С-Битрикс**

**Цель:**
Автоматизировать сбор и анализ данных по конверсиям и рекламным расходам для клиентов на Bitrix, чтобы веб-студии и маркетологи могли видеть полный путь клиента и окупаемость рекламы без ручного сбора данных.

**Возможности:**

1. **Сбор UTM и визитов**

   * Запись UTM-меток и источников при каждом визите.
   * Хранение всей цепочки визитов, а не только last-click.
   * Привязка истории визитов к заказу.

2. **Отдельное хранилище**

   * Данные пишутся в отдельную небитриксовую таблицу (PostgreSQL в облаке).
   * Исключается нагрузка на основную БД Bitrix.

3. **Интеграции с рекламными кабинетами**

   * **Яндекс.Директ API** — загрузка затрат, кликов, показов.
   * **VK Ads API** — загрузка аналогичных данных.
   * В дальнейшем — Google Ads, MyTarget.

4. **Отчётность и аналитика**

   * Сводка по заказам, затратам и доходу.
   * ROI/ROAS по источникам.
   * Визуализация пути клиента (user journey).

**KPI:**

* Снижение потерь конверсий ≥ 90%.
* Экономия времени на отчётность ≥ 50%.

**Примечание:**
Функция внедряется в MVP в минимальном варианте:

* только Яндекс.Директ,
* только базовый путь клиента (до 10 шагов),
* отчёт в виде таблицы + экспорт CSV.

---

## 📄 Дополнение от Researcher для PRD/BRD (новый модуль «Конверсионная аналитика»)

### 1. Позиционирование и связь с текущим функционалом

* Новый модуль **«Конверсионная аналитика»** входит в MVP как дополнительный отчёт в платформе.
* Интеграция:

  * **Текущие SEO/тех. отчёты** → дополнение блоком метрик по UTM, формам, заказам, источникам трафика.
  * Данные из **Bitrix24/CRM** + рекламных платформ (Google Ads API, Яндекс.Директ API).
  * Вывод в интерфейсе и в PDF/CSV отчётах наряду с результатами аудита.

---

### 2. Конкурентный анализ (Bitrix + конверсионная аналитика + рекламные API)

| Продукт/сервис          | Функционал конверсий                        | Интеграции с Bitrix    | Интеграции с рекламными API               | Ограничения                     | Тарифы                       |
| ----------------------- | ------------------------------------------- | ---------------------- | ----------------------------------------- | ------------------------------- | ---------------------------- |
| **Roistat**             | Мультиканальная атрибуция, ROI по кампаниям | Есть модуль под Bitrix | Google Ads, Яндекс.Директ                 | Высокая цена для малого бизнеса | от \~5 000 ₽/мес             |
| **Calltouch**           | Аналитика звонков + онлайн-конверсии        | Есть интеграция        | Google Ads, Яндекс.Директ                 | Сильный фокус на коллтрекинге   | от \~3 000 ₽/мес             |
| **K50**                 | Управление ставками + аналитика             | Есть интеграция        | Google Ads, Яндекс.Директ                 | Заточен под крупные e-com       | Индивидуально                |
| **Bitrix24 CRM отчёты** | Базовая аналитика заказов и лидов           | Встроено               | Ограниченные возможности по рекламным API | Нет гибкой настройки            | Бесплатно в тарифах Bitrix24 |

**Вывод:** На рынке нет массового SaaS, который **в рамках одного отчёта SEO+тех.аудита** показывает ещё и сквозную аналитику с Bitrix и рекламных API — ниша почти пустая.

---

### 3. Техническое решение: онлайн vs батч

| Подход                                      | Плюсы                                                                      | Минусы                                                | Применимость                                    |
| ------------------------------------------- | -------------------------------------------------------------------------- | ----------------------------------------------------- | ----------------------------------------------- |
| **Онлайн-запрос к API при открытии отчёта** | Актуальные данные в момент запроса                                         | Дольше генерация отчёта, риск API-ошибок и блокировок | Подходит для дашбордов, где важна свежесть      |
| **Батч-выгрузка с кэшированием (ETL)**      | Быстрое открытие отчёта, нет зависимости от внешних API в момент просмотра | Данные обновляются с лагом (напр., раз в сутки)       | Оптимально для PDF/CSV и исторической аналитики |

**Рекомендация для MVP:** батч-выгрузка раз в сутки с хранением в отдельной БД конверсий → быстрые отчёты и стабильность SLA.

---

### 4. Архитектура интеграции с Bitrix

**Поток данных:**

1. Модуль на сайте (Bitrix) собирает события (заполнения форм, заказы, посещения с UTM) и отправляет их в облачную шину.
2. ETL-процесс забирает данные из:

   * Bitrix REST API (события/сделки).
   * Google Ads API / Яндекс.Директ API.
3. Данные агрегируются и сохраняются в отдельную БД:

   * Вариант 1: PostgreSQL (TimescaleDB для временных рядов).
   * Вариант 2: ClickHouse (для быстрых агрегатов по большим объёмам).
4. Отчёт формируется из БД и встраивается в интерфейс платформы.

---

### 5. Юридические аспекты (152-ФЗ, GDPR)

* **Категория данных**: ФИО, email, телефон (если попадает в UTM-цепочку) → ПДн.
* **Меры в MVP:**

  1. **Минимизировать**: хранить только необходимые поля (идентификаторы + UTM).
  2. **Анонимизация**: вместо email/телефона — hash с солью.
  3. **Раздельное хранение**: облачная БД конверсий не хранит контактные данные в явном виде.
  4. **Согласие пользователя**: в формах Bitrix добавить чекбокс с офертой о сборе данных для аналитики.
  5. **Шифрование**: AES-256 при хранении + TLS при передаче.
  6. **Локализация**: хранение в РФ, если это российские пользователи (152-ФЗ).

---

### 6. Риски и меры

| Риск                                 | Вероятность | Влияние     | Меры                                |
| ------------------------------------ | ----------- | ----------- | ----------------------------------- |
| Блокировка API по квоте              | Средняя     | Среднее     | Кэширование, распределение запросов |
| Изменения в API рекламных систем     | Высокая     | Высокое     | Версионный слой адаптеров           |
| Утечка ПДн                           | Низкая      | Критическое | Анонимизация, шифрование, аудит     |
| Несогласие пользователя на обработку | Средняя     | Высокое     | Обновление оферт и политик          |

---



## 📄 Дополнения от Researcher к финальному отчёту (новые вводные)

### 1. SLA

* **MVP**: целевой SLA — **99%** доступности.
* **R2+**: повышение до **99.9%** после стабилизации и оптимизации архитектуры.
* **Причины**:

  * Поддержка 99.9% потребует роста TCO на 20–25% (резервирование, отказоустойчивость).
  * На этапе MVP критичнее time-to-market и скорость доработки после пилота.
  * Поднятие SLA после пилотного периода позволит учесть реальную нагрузку и клиентские требования.

---

### 2. Стек (NestJS + FastAPI)

* **ADR-001**: статус **"Accepted"**.
* **Разделение ответственности**:

  * **NestJS** — API, авторизация, панель администратора, интеграция с рекламными и SEO API.
  * **FastAPI** — тяжёлые асинхронные выгрузки, обработка и агрегация метрик, ML/AI-модели.
* **Обоснование**:

  * Стек протестирован на POC.
  * Соответствует плану масштабирования и требованиям по latency.
  * Исключает scope creep и лишние интеграционные задержки.

---

### 3. Биллинг и webhook-потоки

* **Платёжные провайдеры**: **Stripe** + **ЮKassa**.
* **Webhook-потоки**:

  1. Подтверждение подписки (Free→Pro/Agency).
  2. Обновление статуса оплаты.
  3. Обработка возвратов/отмен.
* **Причины утверждения сейчас**:

  * Поддержка нужных моделей подписок и возвратов.
  * Соответствие 152-ФЗ.
  * Позволяет DevOps/Sec реализовать безопасную обработку событий.
  * Избежание блокировки тестирования конверсии тарифов.

---

## 0) Решения уровня ADR (для фиксации)

* **ADR‑001 (Стек бекенда)**: `Accepted` — **NestJS** (API/авторизация/панель) + **FastAPI** (ИИ/Explain, тяжёлые async‑выгрузки, ETL).
* **ADR‑002 (Очередь)**: `Accepted` — **BullMQ (Redis)** для job‑очередей в Node.js. RabbitMQ остаётся опцией для межъязыкового шины (не требуется в MVP). ([Dragonfly][1], [Medium][2])
* **ADR‑003 (PDF)**: `Accepted` — **Puppeteer** в MVP; **Gotenberg** — как горизонтально масштабируемый сервис при росте нагрузки (R2+). ([Rising.js Blog][3], [gotenberg.dev][4], [GitHub][5])
* **ADR‑004 (Time‑series)**: `Accepted` — **PostgreSQL + TimescaleDB** (hypertables, retention 365d, compression on). ([docs.tigerdata.com][6], [docs.timescale.com][7])

---

## 1) Стек бэкенда

**Подтверждаем**: **NestJS (API)** + **FastAPI (ИИ/Explain)** вместо прежнего Laravel.
Обоснование:

* богатая экосистема для Lighthouse/PSI и PDF в Node.js;
* FastAPI удобен для ИИ/обработки и ETL;
* совместимость через Redis/BullMQ (MVP) без ввода комплексного брокера. ([Dragonfly][1])

---

## 2) Очередь: BullMQ (Redis) или RabbitMQ (AMQP)?

**MVP**: **BullMQ (Redis)** — проще интеграция с NestJS, достаточно для фоновых аудитов/рендеринга/ETL.
**Когда RabbitMQ**: нужен сложный роутинг, подтверждения на уровне протокола, кросс‑языковые паттерны (не требуются сейчас). ([Dragonfly][1], [Reddit][8])

**Операционные настройки (MVP):**

* `concurrency` воркера: 3–4 (на под);
* отдельные очереди: `audit:lighthouse`, `audit:psi`, `etl:yandex_direct`, `pdf:render`, `ai:explain`;
* retry policy: экспоненциальный backoff (start=2s, factor=2, max=60s), maxRetries=5;
* idempotency: jobId = детерминированный хэш входа (например, `sha1(url+strategy)` для PSI).

---

## 3) Краулинг (MVP): стратегия

**Подход**: **sitemap‑first** + ограниченный обход внутренних ссылок (для шаблонов).

* Источник URL: `sitemap.xml` (+ `sitemap_index.xml`), валидация кодов ответа.
* Глубина обхода:

  * **LM** (лид‑магнит): 5–10 URL (главная, листинг, карточка, контакты).
  * **Полный аудит (≤100 стр.)**: до **100 URL** по sitemap; если в sitemap >1000 — **sampling** по шаблонам.
* Игнор‑паттерны:

  * query: `?utm_*`, `?gclid=*`, `?yclid=*`, `?fbclid=*`;
  * пути: `/cart`, `/checkout`, `/login`, `/auth`, `/admin`, `/bitrix/*`, `/personal/*`.
* Политика повторов: 429/5xx → retry с backoff.
* Robots уважать; приватные зоны — через модуль (локальные тесты). *(Cloudflare/бот‑фильтры смягчаем честным crawl‑rate и правильным UA; при жёсткой защите — выполнять локально модулем)*. ([Cloudflare Docs][9], [Cloudflare][10])

---

## 4) Параллелизм браузера (Lighthouse/Headless) — профили

**Профиль pod (MVP, k8s/ECS):**

* **Процессы браузера**: 2 (Chromium processes).
* **Вкладки на процесс**: ≤2 (итого до 4 одновременных прогонов).
* **Requests‑budget**: не более 1 PSI‑запроса в секунду на под (см. квоты).
* **Ресурсы**: `cpu: 1.5–2 vCPU`, `memory: 1.5–2.0 GiB` на pod; tmpfs для `/tmp` (PDF/LH артефакты).
* **Флаги**: `--disable-dev-shm-usage`, `--no-sandbox` (если политика), собственный UA.
* Масштабирование: HPA по очередям и времени ожидания job. ([OpenFaaS][11])

---

## 5) PageSpeed Insights (PSI): квоты и кэш

* **Эндпоинт**: `GET https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=...&strategy=mobile|desktop&key=...` — отдаёт Lighthouse JSON + (если есть) полевые метрики CrUX. ([Google for Developers][12])
* **Квоты (де‑факто распространённые значения)**: **25 000 / сутки** и **\~400 / 100 сек** (≈240/мин). Повышение квоты — через GCP Console. ([DEV Community][13], [Stack Overflow][14], [positional.com][15])
* **Кэш (MVP)**:

  * ключ: `psi:{strategy}:{urlNormalized}`;
  * **TTL**: 12–24 часа (рекомендовано 24h для стабильности отчётов);
  * догрев: опционально по расписанию для «избранных» URL;
  * кэш‑штормы: используем single‑flight lock на ключ.

---

## 6) Яндекс.Вебмастер v4: методы, лимиты, backoff

**Целевые методы (v4):**

* **Сайты/права**: `GET /v4/user`, `GET /v4/user/{user-id}/hosts`, `GET /v4/user/{user-id}/hosts/{host-id}`. ([Yandex][16])
* **Диагностика**: `GET /v4/user/{user-id}/hosts/{host-id}/diagnostics` — ошибки сайта. ([Yandex][17])
* **История индексации**: `GET /v4/user/{user-id}/hosts/{host-id}/indexing/history` — количество проиндексированных страниц и статусы. ([Yandex][18])
* **Примеры в поиске/исключённых**:
  `GET /v4/user/{user-id}/hosts/{host-id}/search-urls/samples` и
  `GET /v4/user/{user-id}/hosts/{host-id}/indexing/insearch/samples` (выборки URL, до 50 000). ([Yandex][19])
* **Sitemap**:
  `GET/POST /user-added-sitemaps`, `DELETE /user-added-sitemaps/{sitemap-id}`. ([Yandex][20])
* **Миграция на v4 и поведение** — см. гайд. ([Yandex][21])

**Лимиты/политика**: официально «жёстких цифр» нет в доке; проектируем клиент с:

* **экспоненциальным backoff** (429/5xx), джиттер;
* кэшированием «медленных» ответов (сутки);
* идемпотентностью на добавление sitemap. *(В крайнем случае — падать в деградацию «данные недоступны сейчас»)*. ([Yandex][22])

---

## 7) Пороговые значения (MVP)

**Core Web Vitals (по Google):**

* **LCP**: *Good* ≤ **2.5s**;
* **INP**: *Good* ≤ **200ms**;
* **CLS**: *Good* ≤ **0.1**. ([web.dev][23], [Google Help][24])

**Прочие пороги (MVP‑эвристики):**

* **TTFB**: ≤ **600 ms** (сервер/битрикс‑стек).
* **JS‑ошибки**: >0 на **>5%** проверенных страниц ⇒ fail.
* **HTTPS**: обязателен, валидный сертификат, авто‑редирект HTTP→HTTPS.
* **robots.txt**: не блокирует важные разделы (каталоги/контент); доступен по `/<robots.txt>`.
* **sitemap.xml**: присутствует и отдаёт 200; для индексов — все дочерние доступны; зарегистрирован в Вебмастере.
* **canonical**: существует и не указывает на внешний домен (кроме намеренных канонизаций).

---

## 8) Реестр тестов (окончательный) — JSON/YAML

**JSON (версия для импорта):**

```json
{
  "version": "mvp-1.1",
  "scoring": "100 - sum(penalties)",
  "tests": [
    {"code":"AVAIL_HTTP_5XX","severity":"P0","weight":10,"fail_if":"5xx_rate>0"},
    {"code":"SEC_HTTPS_ENFORCE","severity":"P0","weight":9,"fail_if":"https_enforced=false || cert_valid=false"},
    {"code":"IDX_ROBOTS_BLOCKED","severity":"P0","weight":8,"fail_if":"robots_blocks_important=true"},
    {"code":"SITEMAP_EXISTS_VALID","severity":"P1","weight":7,"fail_if":"sitemap_missing || sitemap_invalid"},
    {"code":"CANONICAL_VALID","severity":"P1","weight":6,"fail_if":"canonical_missing || canonical_crossdomain"},
    {"code":"PERF_LCP_THRESHOLD","severity":"P1","weight":6,"fail_if":"LCP_ms>2500"},
    {"code":"PERF_CLS_THRESHOLD","severity":"P1","weight":6,"fail_if":"CLS>0.1"},
    {"code":"PERF_INP_THRESHOLD","severity":"P1","weight":6,"fail_if":"INP_ms>200"},
    {"code":"PERF_TTFB_THRESHOLD","severity":"P1","weight":7,"fail_if":"TTFB_ms>600"},
    {"code":"JS_CONSOLE_ERRORS","severity":"P1","weight":5,"fail_if":"console_errors_rate>0.05"},
    {"code":"A11Y_ALT_TEXT","severity":"P2","weight":3,"fail_if":"missing_alt_rate>0.2"},
    {"code":"SEO_TITLE_LENGTH","severity":"P2","weight":4,"fail_if":"title_len<10 || title_len>65 || duplicate_titles_rate>0.1"},
    {"code":"SEO_META_DESC","severity":"P2","weight":3,"fail_if":"missing_meta_desc_rate>0.2"},
    {"code":"PERF_RESOURCES_BLOAT","severity":"P2","weight":3,"fail_if":"heavy_resources_rate>0.1"},
    {"code":"REDIRECT_CHAINS","severity":"P2","weight":4,"fail_if":"redirect_chain_rate>0.1"},
    {"code":"SEC_HEADERS","severity":"P1","weight":5,"fail_if":"hsts=false || x_content_type_options=false"},
    {"code":"BX_UPDATE_CORE","severity":"P1","weight":5,"fail_if":"bitrix_core_version<min_supported"},
    {"code":"INT_GSC_YW_CONNECTED","severity":"P2","weight":3,"fail_if":"gsc_connected=false || ywebmaster_connected=false"}
  ]
}
```

**YAML (альтернатива для hand‑edit):**

```yaml
version: mvp-1.1
scoring: "100 - sum(penalties)"
tests:
  - code: AVAIL_HTTP_5XX
    severity: P0
    weight: 10
    fail_if: "5xx_rate>0"
  - code: SEC_HTTPS_ENFORCE
    severity: P0
    weight: 9
    fail_if: "https_enforced=false || cert_valid=false"
  - code: IDX_ROBOTS_BLOCKED
    severity: P0
    weight: 8
    fail_if: "robots_blocks_important=true"
  - code: SITEMAP_EXISTS_VALID
    severity: P1
    weight: 7
    fail_if: "sitemap_missing || sitemap_invalid"
  - code: CANONICAL_VALID
    severity: P1
    weight: 6
    fail_if: "canonical_missing || canonical_crossdomain"
  - code: PERF_LCP_THRESHOLD
    severity: P1
    weight: 6
    fail_if: "LCP_ms>2500"
  - code: PERF_CLS_THRESHOLD
    severity: P1
    weight: 6
    fail_if: "CLS>0.1"
  - code: PERF_INP_THRESHOLD
    severity: P1
    weight: 6
    fail_if: "INP_ms>200"
  - code: PERF_TTFB_THRESHOLD
    severity: P1
    weight: 7
    fail_if: "TTFB_ms>600"
  - code: JS_CONSOLE_ERRORS
    severity: P1
    weight: 5
    fail_if: "console_errors_rate>0.05"
  - code: A11Y_ALT_TEXT
    severity: P2
    weight: 3
    fail_if: "missing_alt_rate>0.2"
  - code: SEO_TITLE_LENGTH
    severity: P2
    weight: 4
    fail_if: "title_len<10 || title_len>65 || duplicate_titles_rate>0.1"
  - code: SEO_META_DESC
    severity: P2
    weight: 3
    fail_if: "missing_meta_desc_rate>0.2"
  - code: PERF_RESOURCES_BLOAT
    severity: P2
    weight: 3
    fail_if: "heavy_resources_rate>0.1"
  - code: REDIRECT_CHAINS
    severity: P2
    weight: 4
    fail_if: "redirect_chain_rate>0.1"
  - code: SEC_HEADERS
    severity: P1
    weight: 5
    fail_if: "hsts=false || x_content_type_options=false"
  - code: BX_UPDATE_CORE
    severity: P1
    weight: 5
    fail_if: "bitrix_core_version<min_supported"
  - code: INT_GSC_YW_CONNECTED
    severity: P2
    weight: 3
    fail_if: "gsc_connected=false || ywebmaster_connected=false"
```

---

## 9) TimescaleDB (подтверждение)

* **Hypertables**: `vitals_lcp`, `vitals_cls`, `vitals_inp`, `vitals_ttfb`, `psi_runs`, `lh_runs`.
* **Retention**: **365d** на сырые ряды (процедура `add_retention_policy`).
* **Compression**: включить на исторических чанках (экономия до **>90%**).
* **Continuous aggregates**: дневные перцентили p50/p75/p95 для графиков. ([docs.tigerdata.com][6], [docs.timescale.com][7])

---

## 10) PDF‑рендер

* **MVP**: **Puppeteer** (Node, общий стек с NestJS). Практики: пул браузеров, отдельный tmp, закрытие контекста после рендера. ([Rising.js Blog][3], [Stack Overflow][25])
* **R2+**: **Gotenberg** как stateless‑сервис (Chromium routes, multipart). Даёт простое горизонтальное масштабирование и изоляцию нагрузок PDF. ([gotenberg.dev][26], [GitHub][5])

---

## 11) ИИ‑Explain

* **Источник подсказок**:

  * правила из реестра тестов (`fail_if`, `severity`, `weight`);
  * справочники Core Web Vitals (тексты best‑practice, ссылки). ([web.dev][23])
* **Тон**: RU/EN, «деловой/конкретный», без запугивания; формат «что это / почему важно / как исправить в Битрикс».
* **Ограничения**:

  * **не** обещать «автопочинку»;
  * **не** давать советы, противоречащие robots/security/юрисдикции;
  * помечать неопределённость (например, «возможна блокировка WAF/Cloudflare — проверьте локальным модулем»). ([Cloudflare Docs][9])

---

## 12) Веб‑хуки (billing, экспорт задач) — форматы и идемпотентность

**12.1 Billing (Stripe / ЮKassa)**

* **Endpoint (наш)**: `POST /webhooks/billing/{provider}`
* **Headers**: `X-Provider: stripe|yookassa`, `Idempotency-Key: <event_id>`
* **Проверка подписи**: секрет провайдера (Stripe‑подпись, ЮKassa webhook secret).
* **Payload (пример, унифицированный):**

```json
{
  "event_id": "evt_123",
  "event_type": "subscription.updated",
  "provider": "stripe",
  "occurred_at": "2025-08-13T12:34:56Z",
  "data": {
    "account_id": "acc_42",
    "subscription_id": "sub_abc",
    "plan": "agency",
    "status": "active",
    "period_start": "2025-08-01",
    "period_end": "2025-09-01",
    "amount": 2500,
    "currency": "RUB"
  }
}
```

* **Idempotency**: хранить `event_id` в таблице `billing_events`; дубли — 200 OK, без повторной обработки.

**12.2 Экспорт задач (Jira/YouTrack/ClickUp)**

* **Outbound webhook** (по событию `report_ready` или `finding_created:P0/P1`):

  * Headers: `Authorization: Bearer <token>`, `Idempotency-Key: <run_id>:<finding_code>`
  * Payload (минимум):

```json
{
  "external_system": "jira",
  "project_key": "SEO",
  "title": "[P0][LCP] /catalog — LCP > 2.5s on mobile",
  "description_md": "Что это / почему / как исправить ...",
  "labels": ["audit","core-web-vitals","bitrix"],
  "severity": "P0",
  "source": {"site_id": "s_1001", "run_id": "r_20250813_01", "test_code": "PERF_LCP_THRESHOLD"},
  "links": [{"rel": "report", "href": "https://app/audits/r_20250813_01"}]
}
```

* **Inbound webhook** (обновление статуса задачи):

  * Headers: `X-Signature`, `Idempotency-Key: <task_id>:<status>:<ts>`
  * Сопоставление по `external_issue_id`.

---

## 13) Конкурентный радар (для нового модуля «Конверсионная аналитика»)

| Сервис                  | Bitrix‑интеграция | Рекламные API             | Фокус                         | Вывод для нас                                                                          |
| ----------------------- | ----------------- | ------------------------- | ----------------------------- | -------------------------------------------------------------------------------------- |
| **Roistat**             | Есть              | Google Ads, Яндекс.Директ | сквозная аналитика, атрибуция | Сильный игрок, но не объединяет **в одном отчёте** с SEO/тех. аудитом; ценник выше SMB |
| **Calltouch**           | Есть              | Google Ads, Яндекс.Директ | коллтрекинг + онлайн          | Сильнее по звонкам; менее релевантен для Bitrix e‑com                                  |
| **K50**                 | Есть              | Google Ads, Яндекс.Директ | управление ставками           | Enterprise‑фокус, не про аудит                                                         |
| **Bitrix24 CRM отчёты** | Встроено          | ограниченно               | CRM‑аналитика                 | Нет глубины интеграции с Lighthouse/PSI                                                |

**Ниша** для «**SEO/тех‑аудит + сквозная аналитика Bitrix**» остаётся свободной — дифференциатор для MVP.

---

## 14) Риски (добавлено для нового модуля)

* **Квоты PSI и Яндекс.Вебмастер** — смягчаем кэшем/батчем/ретраями. ([DEV Community][13], [Stack Overflow][14])
* **WAF/Cloudflare‑челленджи** — честный crawl‑rate, корректный UA, локальный модуль для приватных зон. ([Cloudflare Docs][9])
* **152‑ФЗ/PII** — анонимизация (hash с солью), минимизация полей, хранение в РФ.
* **Расхождения отчётов рекламных систем vs CRM** — reconciliation‑скрипты, ручная сверка.

---

### Приложение A — Мини‑спецификация PSI клиента (TypeScript)

```ts
type Strategy = 'mobile' | 'desktop';
type PsiKey = `psi:${Strategy}:${string}`; // normalized URL

interface PsiOptions {
  url: string;
  strategy: Strategy;
  key: string; // GCP API key
  timeoutMs?: number; // 30_000 default
}

const PSI_TTL_SEC = 60 * 60 * 24; // 24h

// cache get/set by key; single-flight lock to avoid stampede
```

---

### Приложение B — Полезные ссылки

* PageSpeed Insights v5 (эндпоинт, метрики/CrUX): ([Google for Developers][12])
* PSI квоты (де‑факто 25k/day, 400/100s): ([DEV Community][13], [Stack Overflow][14], [positional.com][15])
* Core Web Vitals (LCP/INP/CLS) и пороги: ([web.dev][23], [Google Help][24])
* Яндекс.Вебмастер API v4 (диагностика, индексация, sitemaps, hosts): ([Yandex][17])
* TimescaleDB: retention / compression: ([docs.tigerdata.com][6], [docs.timescale.com][7])
* PDF в масштабе: Puppeteer / Gotenberg: ([Rising.js Blog][3], [gotenberg.dev][26])
* Очереди: BullMQ vs RabbitMQ: ([Dragonfly][1])
* Cloudflare WAF/боты: ([Cloudflare Docs][9])

---

Дополнения к документам (для фиксации)

Методика: скоринг 100 − Σ(штрафов); реестр тестов P0–P3 как стандарт MVP {BA}{Researcher}.
Приоритет интеграций: PSI → batch-Lighthouse; квоты/кэш: ~240 rpm / 25k/day; url+strategy {SA}.
